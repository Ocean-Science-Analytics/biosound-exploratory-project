<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>BioSound Exploratory Project - Evaluating Indices</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./analysis.html">Evaluating Indices</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./images/BioSound.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Project Overview</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./indices.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Acoustic Indices</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Processing &amp; Management</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analysis.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Evaluating Indices</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./recommendations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Recommendations</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#diel-diurnal-trends" id="toc-diel-diurnal-trends" class="nav-link active" data-scroll-target="#diel-diurnal-trends">Diel &amp; Diurnal Trends</a></li>
  <li><a href="#relationship-with-environmental-data" id="toc-relationship-with-environmental-data" class="nav-link" data-scroll-target="#relationship-with-environmental-data">Relationship with Environmental Data</a></li>
  <li><a href="#initial-exploration-of-multivariate-analyses" id="toc-initial-exploration-of-multivariate-analyses" class="nav-link" data-scroll-target="#initial-exploration-of-multivariate-analyses">Initial Exploration of Multivariate Analyses</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Evaluating Indices</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>An evaluation of the dashboard data revealed several interesting trends in the acoustic indices. Highlights are indicated below, and a more comprehensive summary can be found by downloading the <a href="downloads/OSA_BioSound_Summary.pdf">Exploratory Summary</a>.</p>
<section id="diel-diurnal-trends" class="level3">
<h3 class="anchored" data-anchor-id="diel-diurnal-trends">Diel &amp; Diurnal Trends</h3>
<p>We conducted a qualitative evaluation of trends and differences across all datasets by reviewing heatmaps generated by normalizing the value of each acoustic index. These heatmaps were produced for either the full bandwidth or a reduced 16 kHz sampling rate and plotted by the hour of the day. Our objective was to uncover diel (24-hour cycle) and diurnal (daytime-focused) trends by visualizing how acoustic indices fluctuated throughout the day. Among the three available plots in the BioSound-MBON analytical tool, Plot 3 proved to be the most impactful. This plot displayed the range of normalized, user-selected index values by date on the x-axis and hour of the day on the y-axis, providing a clear temporal pattern for the month of February. We selected February 2019 as the common month for analysis to enable consistent comparisons across most datasets, with the exception of Key West, where data was collected in February 2020.</p>
<p>Key trends observed in our analysis included:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-1916758219.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Observed Patterns</p>
<p>Our analysis of diel and diurnal trends across multiple datasets revealed intriguing patterns that appear to correlate with tidal cycles. For several datasets and across various acoustic indices, a notable pattern emerged that aligns with tidal fluctuations, characterized by larger index measurements approximately every 6 to 7 hours (<strong>Figure 1</strong>). This cyclic pattern exhibited a consistent shift of about one hour forward each day throughout February, suggesting a potential link to tidal rhythms. The Biscayne Bay (a mangrove ecosystem) and May River (an estuary) datasets demonstrated this trend most prominently across multiple indices. Both sites share similar shallow depths of approximately 4.5 meters, which may amplify the influence of tidal movements on acoustic measurements.</p>
<p>In addition to tidal-associated patterns, we identified a distinct diurnal trend across several datasets (<strong>Figure 2</strong>). This pattern manifested as either lower acoustic index values during daylight hours with higher values in the evening and nighttime, or the inverse, with heightened activity during the day. This diurnal fluctuation was consistently observed across multiple indices and appeared most frequently in the Gray’s Reef and Key West datasets. Unlike the shallow environments of Biscayne Bay and May River, these sites feature recorder depths of 16 meters and 23 meters, respectively. The increased depth at these locations might contribute to the observed light-driven acoustic patterns, possibly influenced by the behaviors of marine organisms, variations in abiotic noise sources, or changes in water column properties throughout the day.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-4281538417.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="604"></p>
</figure>
</div>
<p><strong>Figure 1</strong>: Example of apparent tidal pattern represented in multiple indices. This example from Biscayne Bay in February is the ACTspMean (Temporal Index), 32 kHz sampling rate.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-1395905719.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p><strong>Figure 2</strong>: Diurnal trends observed in multiple datasets and indices. This example includes A) Gray’s Reef, BGNf index (Amplitude Index) calculated from 48 kHz data and B) Key West, BGNf index (Amplitude Index) calculated from 48 kHz data.</p>
<p>We observed that the patterns present in the native bandwidth of each acoustic index were often mirrored in the low sampling rate examples, albeit with some variations in the intensity of index values (<strong>Figure 3</strong>). This consistency in patterns across both the full bandwidth and the reduced 16 kHz sampling rate suggests that much of the influence on these acoustic indices may be concentrated in the lower frequency ranges. Lower frequencies often capture sounds from a broad spectrum of sources, including environmental noise, certain marine mammal vocalizations, and anthropogenic activities, which might drive these observed trends. The alignment of patterns across sampling rates reinforces the potential utility of lower frequency monitoring for capturing meaningful ecological and environmental signals.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-144010564.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p><strong>Figure 3</strong>: Similar patterns exhibited in full bandwidth and decimated data. This example includes A) Gray’s Reef, BGNf index (Amplitude Index) calculated from 48 kHz data and B) Key West, BGNf index (Amplitude Index) calculated from 16 kHz data.</p>
</section>
<section id="relationship-with-environmental-data" class="level3">
<h3 class="anchored" data-anchor-id="relationship-with-environmental-data">Relationship with Environmental Data</h3>
<p>We examined categories of acoustic indices to assess whether any consistent trends emerged by region, particularly focusing on whether similar habitats exhibited comparable correlations with water classes. However, our results did not reveal a clear pattern of consistency across similar environments. For instance, given the similarity in diel patterns between Biscayne Bay and May River, we initially hypothesized that these regions would exhibit comparable correlations with Seascapes water classes. Contrary to our expectations, <strong>Table 2</strong> demonstrates that each region displayed distinctly different correlation profiles. Biscayne Bay showed strong positive correlations among many of the complexity indices, whereas May River presented variable, low to moderate correlations, suggesting that even within seemingly similar shallow water habitats, underlying environmental or ecological differences influence acoustic index relationships differently.</p>
<p><strong>Table 2:</strong> Pearson correlation coefficient values for Biscayne Bay and May River for water class 15. Extreme green cells indicates large positive correlation, and a large negative value indicates a strong negative correlation.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-260896779.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>To explore this further, we shifted our focus to per-index correlation measures per water class, aiming to determine whether at least specific acoustic index measurements maintained consistent correlations within particular water classes. This analysis involved plotting the distribution of mean index values, calculated across eight-day intervals to align with the temporal resolution of the remotely sensed water class data, and comparing these to the observed correlation coefficients. For example, Water Class 12, which comprises a substantial portion of the ONC-MEF and OOI-HYDBBA106 datasets (<strong>Figure 4</strong>), exhibited opposite extreme correlation coefficients between these datasets. We visualized the mean index values for the SNRt, HpairedShannon, and EVNtMean indices to interpret these trends. Our analysis revealed that increased index values were associated with lower extreme correlation values for both EVNtMean and SNRt (<strong>Figure 5</strong>). However, this pattern did not hold for HpairedShannon, which showed reduced index measures at the ONC-MEP site, despite a similarly strong negative correlation coefficient. Importantly, while specific trends within single water classes were occasionally evident, these associations did not translate consistently across other water classes. For instance, in Water Class 15 (<strong>Figure 6</strong>), high values of HpairedShannon did not correlate with a drastic decrease in correlation coefficients, demonstrating the complex and potentially site-specific nature of these relationships.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-1490404320.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="769"></p>
</figure>
</div>
<p><strong>Figure 4:</strong> Composition of water class data for the period of March through April 2019 to give context in the representation of water classes in a region. Only February is incorporated in subsequent analyses. Water class 12 is only found in the OOI-HYDBBA106 and ONC-MEF datasets.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-2602452646.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="700"></p>
</figure>
</div>
<p><strong>Figure 5:</strong> Plots of the distribution of mean index values associated with water class 12. Only datasets with profiles consistent of 5 or more cells of the specified water class are reported. Pearson correlation coefficients are reported for comparison to index measurements. Water class 12 is only represented in ONC-MEF and OOI-HYDBBA106. This figure displays measurements for EVNtMean (A), H_pairedShannon (B), and SNRt (C).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-1866504204.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="746"></p>
</figure>
</div>
<p><strong>Figure 6:</strong> Distribution of mean H_pairedShannon measurements by dataset and associated correlation coefficient for water class 15. No relationship between correlation coefficients and measurements is noted across sites.</p>
</section>
<section id="initial-exploration-of-multivariate-analyses" class="level3">
<h3 class="anchored" data-anchor-id="initial-exploration-of-multivariate-analyses">Initial Exploration of Multivariate Analyses</h3>
<p>As a cursory investigation into the potential use of a combined index approach for evaluating the unique natures of these datasets, we applied two advanced analytical techniques to explore how a multi-index framework might enhance our understanding of marine soundscapes. This preliminary analysis aimed to determine whether combining multiple acoustic indices could reveal latent patterns and relationships not evident when indices are considered in isolation. The analytical methods employed included:</p>
<ul>
<li><p><strong>Principal Component Analysis (PCA):</strong> Performed on 10 select presentative acoustic indices from each index category (e.g., per site to reduce dimensionality and highlight key patterns.</p></li>
<li><p><strong>K-Means Clustering:</strong> Classified sites into 8 groups based on their acoustic profiles, providing insights into site relationships and ecological significance.</p></li>
</ul>
<p>We explored the natural structure of the acoustic indices by combining two complementary analytical techniques. We applied Principal Component Analysis (PCA) to the normalized indices to show that the multidimensional relationships could be mapped onto two principal dimensions (<strong>Figure 7</strong>). The dimensional reduction allowed us to identify the main gradients of variation. Each feature’s contribution to these principal components was carefully measured through loading coefficients, revealing which variables were most influential. In parallel, we introduced k-means clustering (k=8) to identify whether the natural groupings that emerge coincided with the geographical origins of the measured indices.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-1999674245.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="602"></p>
</figure>
</div>
<p><strong>Figure 7</strong>: Principal component contributions of acoustic index to PC1 and PC2.</p>
<p>Our analysis revealed that k-means clustering patterns did not significantly correlate with geographical locations (<strong>Figure 8A</strong>). Interestingly, however, location groupings formed distinct clusters within the principal component space (<strong>Figure 8B</strong>). We observed that geographically proximate regions often displayed similar acoustic profiles, suggesting a spatial gradient in acoustic properties. This spatial coherence provides promising evidence that acoustic indices may effectively characterize different soundscapes, potentially offering a quantitative method for distinguishing between acoustic environments.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-399653410.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="722"></p>
</figure>
</div>
<p><strong>Figure 8:</strong> PCA plots by k-means clusters (A) and location clusters (B).</p>
<p>Visual representations of the Principal Component Analysis (PCA) and K-Means clustering results were generated to support the interpretation of clustering and site associations. These visualizations allow for an interactive exploration of the multivariate analysis, enabling users to compare K-Means clusters and site-specific clusters for the set of 10 indices utilized in the cursory review of multivariate methods. To provide an interactive perspective, these visualizations are available online at: <a href="https://observablehq.com/@michw-workspace/exploring-biosound-data">Exploring BioSound Data</a>.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>